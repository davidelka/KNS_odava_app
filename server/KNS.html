<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Knesset OData URL Builder</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="./style.css" />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            /* Additional styles for the new expand builder */
            .expand-clause-level {
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
                background-color: #f9fafb;
            }
            .expand-clause-level .level-header {
                font-weight: 600;
                margin-bottom: 10px;
                color: #374151;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .expand-clause-level .level-controls {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
                align-items: center;
            }
            .expand-clause-level .level-controls select,
            .expand-clause-level .level-controls input[type="text"] {
                flex-grow: 1;
                min-width: 0;
            }
            .expand-clause-level .nested-expands-container {
                margin-top: 15px;
                padding-left: 20px;
                border-left: 2px solid #d1d5db;
            }
            .add-nested-expand-btn {
                background-color: #3b82f6; /* Blue-500 */
                color: white;
                border: none;
                padding: 6px 10px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.875rem;
                transition: background-color 0.2s ease-in-out;
            }
            .add-nested-expand-btn:hover {
                background-color: #2563eb; /* Blue-600 */
            }
            .remove-level-btn {
                background-color: #ef4444; /* Red-500 */
                color: white;
                padding: 6px 10px;
                border-radius: 6px;
                cursor: pointer;
                border: none;
                font-weight: 500;
                transition: background-color 0.2s ease-in-out;
            }
            .remove-level-btn:hover {
                background-color: #dc2626; /* Red-600 */
            }
            .add-top-level-expand-btn {
                background-color: #10b981; /* Emerald-500 */
                color: white;
                border: none;
                margin-top: 10px;
            }
            .add-top-level-expand-btn:hover {
                background-color: #059669; /* Emerald-600 */
            }
        </style>
    </head>
    <body
        class="flex items-center justify-content-center min-h-screen bg-gray-100 p-5"
    >
        <div class="container">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
                Knesset OData URL Builder
            </h1>

            <div class="form-group">
                <label for="baseUrl">Base URL:</label>
                <input
                    type="text"
                    id="baseUrl"
                    value="https://knesset.gov.il/OdataV4/ParliamentInfo/"
                    readonly
                    class="bg-gray-50 cursor-not-allowed"
                />
            </div>

            <div class="form-group">
                <label for="tableSelect">Select Table:</label>
                <select
                    id="tableSelect"
                    class="focus:ring-blue-500 focus:border-blue-500"
                ></select>
            </div>

            <div class="form-group">
                <label>Build Filters:</label>
                <div id="filterClausesContainer"></div>
                <button id="addFilterClauseBtn" class="btn add-filter-btn">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                            clip-rule="evenodd"
                        />
                    </svg>
                    Add Filter Clause
                </button>
            </div>

            <div class="form-group">
                <label>Order By:</label>
                <div class="flex gap-4 items-center">
                    <select
                        id="orderByFieldSelect"
                        class="flex-grow p-2 border rounded-md"
                    >
                        <option value="">-- Select Field to Order By --</option>
                    </select>
                    <select
                        id="orderByDirectionSelect"
                        class="p-2 border rounded-md"
                    >
                        <option value="asc">Ascending</option>
                        <option value="desc">Descending</option>
                    </select>
                </div>
            </div>

            <!-- New Dynamic Expand Builder -->
            <div class="form-group">
                <label>Build Expands:</label>
                <div id="mainExpandContainer">
                    <!-- Expand levels will be added here -->
                </div>
                <button
                    id="addTopLevelExpandBtn"
                    class="btn add-top-level-expand-btn"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                            clip-rule="evenodd"
                        />
                    </svg>
                    Add Top-Level Expand
                </button>
                <div class="form-group mt-4">
                    <label
                        >Suggested Expands for
                        <span
                            id="currentTableExpandSuggestions"
                            class="font-semibold text-blue-700"
                        ></span
                        >:</label
                    >
                    <div
                        id="expandSuggestionsContainer"
                        class="flex flex-wrap gap-2 mt-2"
                    >
                        <!-- Suggestions will be populated here -->
                    </div>
                </div>
            </div>

            <div class="flex space-x-4 mb-6 mt-4">
                <button id="generateUrlBtn" class="btn btn-primary flex-grow">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                            clip-rule="evenodd"
                        />
                    </svg>
                    Generate URL
                </button>
                <button id="copyUrlBtn" class="btn btn-secondary flex-grow">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"
                        />
                        <path
                            d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6zM5 9a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z"
                        />
                    </svg>
                    Copy URL
                </button>
            </div>

            <div class="form-group">
                <label for="outputUrl">Generated URL (Editable):</label>
                <textarea
                    id="outputUrl"
                    class="output-box w-full h-24 p-3 border rounded-md resize-y"
                ></textarea>
            </div>

            <div class="form-group">
                <label for="filenameInput"
                    >Filename Base (e.g., `my_data`):</label
                >
                <input
                    type="text"
                    id="filenameInput"
                    value="knesset_odata_data"
                    class="focus:ring-blue-500 focus:border-blue-500"
                />

                <label for="saveFormatSelect" class="mt-4">Save Format:</label>
                <select
                    id="saveFormatSelect"
                    class="focus:ring-blue-500 focus:border-blue-500"
                >
                    <option value="json">JSON (.json)</option>
                    <option value="csv">CSV (.csv)</option>
                    <option value="both">Both (JSON & CSV)</option>
                </select>

                <button
                    id="fetchAndSaveBtn"
                    class="btn btn-primary mt-4 w-full"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                            clip-rule="evenodd"
                        />
                    </svg>
                    Fetch & Save Data (on server)
                </button>
                <p class="text-sm text-gray-600 mt-2">
                    Note: Data will be saved to a file(s) on the server running
                    this application. Check the server's directory.
                </p>
            </div>

            <div id="messageBox" class="message-box"></div>
        </div>

        <script type="module">
            // Import data from odataConfig.js
            import {
                TABLES,
                TABLE_FIELDS_METADATA,
                TABLE_NAVIGATION_PROPERTIES_MAP,
            } from "./odataConfig.js";

            // Define the base URL for the OData service
            const BASE_URL = "https://knesset.gov.il/OdataV4/ParliamentInfo/";
            // Define the endpoint for the Python backend
            const BACKEND_URL = "http://127.0.0.1:5000/fetch_and_save_data"; // Assuming Flask runs on port 5000

            // Define the maximum allowed expansion depth by the OData service
            const MAX_EXPANSION_DEPTH = 2; // As per the error message

            // Get references to DOM elements
            const tableSelect = document.getElementById("tableSelect");
            const filterClausesContainer = document.getElementById(
                "filterClausesContainer",
            );
            const addFilterClauseBtn =
                document.getElementById("addFilterClauseBtn");
            const orderByFieldSelect =
                document.getElementById("orderByFieldSelect");
            const orderByDirectionSelect = document.getElementById(
                "orderByDirectionSelect",
            );
            const mainExpandContainer = document.getElementById(
                "mainExpandContainer",
            );
            const addTopLevelExpandBtn = document.getElementById(
                "addTopLevelExpandBtn",
            ); // New button
            const expandSuggestionsContainer = document.getElementById(
                "expandSuggestionsContainer",
            );
            const currentTableExpandSuggestionsSpan = document.getElementById(
                "currentTableExpandSuggestions",
            );
            const generateUrlBtn = document.getElementById("generateUrlBtn");
            const copyUrlBtn = document.getElementById("copyUrlBtn");
            const outputUrl = document.getElementById("outputUrl");
            const filenameInput = document.getElementById("filenameInput");
            const saveFormatSelect =
                document.getElementById("saveFormatSelect");
            const fetchAndSaveBtn = document.getElementById("fetchAndSaveBtn");
            const messageBox = document.getElementById("messageBox");

            // Regex to check for OData datetime format (YYYY-MM-DDTHH:MM:SSZ or YYYY-MM-DD)
            const ODATA_DATETIME_REGEX =
                /^\d{4}-\d{2}-\d{2}(T\d{2}:\d{2}:\d{2}(Z)?)?$/;
            // Operators that typically do not require quotes for non-string types (like numbers, booleans, dates)
            const COMPARISON_OPERATORS = ["eq", "ne", "gt", "lt", "ge", "le"];

            /**
             * Populates the table selection dropdown with available table names.
             */
            function populateTableSelect() {
                TABLES.forEach((table) => {
                    const option = document.createElement("option");
                    option.value = table;
                    option.textContent = table;
                    tableSelect.appendChild(option);
                });
            }

            /**
             * Populates the field dropdown for a given filter clause or order by based on the selected table.
             * @param {HTMLSelectElement} fieldSelectElement - The select element for fields.
             * @param {string} tableName - The name of the currently selected table.
             */
            function populateFieldSelect(fieldSelectElement, tableName) {
                fieldSelectElement.innerHTML =
                    '<option value="">-- Select Field --</option>'; // Clear existing options
                const fields = TABLE_FIELDS_METADATA[tableName] || [];
                fields.forEach((field) => {
                    const option = document.createElement("option");
                    option.value = field.name;
                    option.textContent = field.name;
                    fieldSelectElement.appendChild(option);
                });
            }

            /**
             * Populates the expand suggestions based on the currently selected table.
             */
            function populateExpandSuggestions() {
                const selectedTable = tableSelect.value;
                expandSuggestionsContainer.innerHTML = ""; // Clear existing suggestions
                currentTableExpandSuggestionsSpan.textContent = selectedTable; // Update current table name in label

                const suggestions =
                    TABLE_NAVIGATION_PROPERTIES_MAP[selectedTable] || [];

                if (suggestions.length === 0) {
                    expandSuggestionsContainer.textContent =
                        "No direct expand suggestions for this table.";
                } else {
                    suggestions.forEach((prop) => {
                        const span = document.createElement("span");
                        span.className =
                            "inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full cursor-pointer hover:bg-blue-200 transition-colors duration-200";
                        span.textContent = prop.name;
                        span.dataset.value = prop.name; // Store the direct property name

                        span.addEventListener("click", () => {
                            // Find the last active expand clause's custom input
                            const lastExpandClauseLevel =
                                mainExpandContainer.lastElementChild;
                            if (lastExpandClauseLevel) {
                                const customInput =
                                    lastExpandClauseLevel.querySelector(
                                        ".expand-custom-input",
                                    );
                                if (customInput) {
                                    const currentValue =
                                        customInput.value.trim();
                                    if (currentValue) {
                                        // If current input has content, append with comma
                                        customInput.value = `${currentValue},${suggestion.name}`;
                                    } else {
                                        // Otherwise, just set it
                                        customInput.value = suggestion.name;
                                    }
                                    generateUrl(); // Regenerate URL after adding suggestion
                                }
                            }
                        });
                        expandSuggestionsContainer.appendChild(span);
                    });
                }
            }

            /**
             * Adds a new filter clause row to the UI.
             */
            function addFilterClause() {
                const clauseDiv = document.createElement("div");
                clauseDiv.className = "filter-clause";

                const logicalOperatorSelect = document.createElement("select");
                logicalOperatorSelect.className =
                    "logical-operator-select p-2 border rounded-md";
                logicalOperatorSelect.innerHTML = `
                <option value="and">AND</option>
                <option value="or">OR</option>
            `;
                // Only show logical operator if there are existing clauses
                if (filterClausesContainer.children.length === 0) {
                    logicalOperatorSelect.style.display = "none";
                }

                const fieldSelect = document.createElement("select");
                fieldSelect.className = "p-2 border rounded-md";
                populateFieldSelect(fieldSelect, tableSelect.value); // Populate initially based on current table

                const operatorSelect = document.createElement("select");
                operatorSelect.className = "p-2 border rounded-md";
                operatorSelect.innerHTML = `
                <option value="eq">eq (equal)</option>
                <option value="ne">ne (not equal)</option>
                <option value="gt">gt (greater than)</option>
                <option value="lt">lt (less than)</option>
                <option value="ge">ge (greater or equal)</option>
                <option value="le">le (less or equal)</option>
                <option value="contains">contains (string)</option>
                <option value="startswith">startswith (string)</option>
                <option value="endswith">endswith (string)</option>
            `;

                const valueInput = document.createElement("input");
                valueInput.type = "text";
                valueInput.placeholder = "Value";
                valueInput.className = "p-2 border rounded-md";

                const removeBtn = document.createElement("button");
                removeBtn.className = "remove-btn";
                removeBtn.textContent = "Remove";
                removeBtn.addEventListener("click", () => {
                    clauseDiv.remove();
                    generateUrl(); // Regenerate URL after removal
                    // Hide logical operator of the first remaining clause if it's now the only one
                    if (filterClausesContainer.children.length > 0) {
                        filterClausesContainer.children[0].querySelector(
                            ".logical-operator-select",
                        ).style.display = "none";
                    }
                });

                clauseDiv.appendChild(logicalOperatorSelect);
                clauseDiv.appendChild(fieldSelect);
                clauseDiv.appendChild(operatorSelect);
                clauseDiv.appendChild(valueInput);
                clauseDiv.appendChild(removeBtn);

                filterClausesContainer.appendChild(clauseDiv);

                // Add event listeners to trigger URL generation on input/change
                fieldSelect.addEventListener("change", generateUrl);
                operatorSelect.addEventListener("change", generateUrl);
                valueInput.addEventListener("input", generateUrl);
                logicalOperatorSelect.addEventListener("change", generateUrl);

                // If this is not the first clause, ensure the previous one's logical operator is visible
                if (filterClausesContainer.children.length > 1) {
                    filterClausesContainer.children[0].querySelector(
                        ".logical-operator-select",
                    ).style.display = "block";
                }

                generateUrl(); // Generate URL immediately after adding a clause
            }

            /**
             * Recursively adds a nested expand level.
             * @param {HTMLElement} parentContainer - The container to which the new level will be added.
             * @param {string} currentEntityType - The entity type whose navigation properties should be listed.
             * @param {number} level - The current nesting level (for display purposes).
             */
            function addNestedExpandLevel(
                parentContainer,
                currentEntityType,
                level = 0,
            ) {
                const levelDiv = document.createElement("div");
                levelDiv.className = "expand-clause-level";
                levelDiv.dataset.entityType = currentEntityType; // Store the entity type for this level

                const levelHeader = document.createElement("div");
                levelHeader.className = "level-header";
                levelHeader.innerHTML = `<span>Level ${level + 1}: Expand from <span class="font-bold">${currentEntityType}</span></span>`;

                const removeButton = document.createElement("button");
                removeButton.className = "remove-level-btn";
                removeButton.textContent = "Remove Level";
                removeButton.addEventListener("click", () => {
                    levelDiv.remove();
                    generateUrl(); // Regenerate URL after removal
                });
                levelHeader.appendChild(removeButton);
                levelDiv.appendChild(levelHeader);

                const levelControls = document.createElement("div");
                levelControls.className = "level-controls";

                const navPropSelect = document.createElement("select");
                navPropSelect.className =
                    "nav-prop-select p-2 border rounded-md";
                populateNavPropSelect(navPropSelect, currentEntityType);
                levelControls.appendChild(navPropSelect);

                const customInput = document.createElement("input");
                customInput.type = "text";
                customInput.placeholder =
                    "Custom expand or nested (e.g., Prop($expand=NestedProp))";
                customInput.className =
                    "expand-custom-input p-2 border rounded-md";
                levelControls.appendChild(customInput);

                levelDiv.appendChild(levelControls);

                const nestedContainer = document.createElement("div");
                nestedContainer.className = "nested-expands-container";
                levelDiv.appendChild(nestedContainer);

                parentContainer.appendChild(levelDiv);

                // Add nested expand button only if not at max depth
                if (level < MAX_EXPANSION_DEPTH) {
                    const addNestedBtn = document.createElement("button");
                    addNestedBtn.className = "add-nested-expand-btn mt-2";
                    addNestedBtn.textContent = `Add Nested Expand for ${currentEntityType}`;
                    addNestedBtn.addEventListener("click", () => {
                        addNestedExpandLevel(
                            nestedContainer,
                            navPropSelect.selectedOptions[0].dataset
                                .targetType || "",
                            level + 1,
                        );
                    });
                    levelControls.appendChild(addNestedBtn);
                } else {
                    const warningSpan = document.createElement("span");
                    warningSpan.className = "text-sm text-red-500 mt-2";
                    warningSpan.textContent = `Max expand depth (${MAX_EXPANSION_DEPTH}) reached.`;
                    levelControls.appendChild(warningSpan);
                }

                // Event listener for selection change in this level's dropdown
                navPropSelect.addEventListener("change", () => {
                    const selectedNavPropName = navPropSelect.value;
                    // Clear any existing nested levels and nested button when a new selection is made
                    nestedContainer.innerHTML = "";
                    const existingAddNestedBtn = levelControls.querySelector(
                        ".add-nested-expand-btn",
                    );
                    if (existingAddNestedBtn) existingAddNestedBtn.remove();

                    customInput.value = selectedNavPropName; // Set custom input to selected value

                    if (selectedNavPropName && level < MAX_EXPANSION_DEPTH) {
                        const navProps =
                            TABLE_NAVIGATION_PROPERTIES_MAP[
                                currentEntityType
                            ] || [];
                        const selectedProp = navProps.find(
                            (p) => p.name === selectedNavPropName,
                        );

                        if (selectedProp && selectedProp.targetType) {
                            // Add a button to add a nested level for the target type
                            const addNestedBtn =
                                document.createElement("button");
                            addNestedBtn.className =
                                "add-nested-expand-btn mt-2";
                            addNestedBtn.textContent = `Add Nested Expand for ${selectedProp.targetType}`;
                            addNestedBtn.addEventListener("click", () => {
                                // Recursively add a new level inside the nestedContainer
                                addNestedExpandLevel(
                                    nestedContainer,
                                    selectedProp.targetType,
                                    level + 1,
                                );
                            });
                            levelControls.appendChild(addNestedBtn); // Add button to current level's controls
                        }
                    }
                    generateUrl(); // Regenerate URL
                });

                // Event listener for custom input change
                customInput.addEventListener("input", () => {
                    navPropSelect.value = ""; // Clear select if custom input is used
                    nestedContainer.innerHTML = ""; // Clear nested levels if custom input is used
                    const addNestedBtn = levelControls.querySelector(
                        ".add-nested-expand-btn",
                    );
                    if (addNestedBtn) addNestedBtn.remove(); // Remove nested button if custom input is used
                    generateUrl();
                });

                generateUrl(); // Initial URL generation
            }

            /**
             * Populates a navigation property select dropdown for a given entity type.
             * @param {HTMLSelectElement} selectElement - The select element to populate.
             * @param {string} entityType - The entity type for which to get navigation properties.
             */
            function populateNavPropSelect(selectElement, entityType) {
                selectElement.innerHTML =
                    '<option value="">-- Select Property --</option>';
                const navProps =
                    TABLE_NAVIGATION_PROPERTIES_MAP[entityType] || [];
                navProps.forEach((prop) => {
                    const option = document.createElement("option");
                    option.value = prop.name;
                    option.textContent = prop.name;
                    option.dataset.targetType = prop.targetType; // Store target type for nested expands
                    selectElement.appendChild(option);
                });
            }

            /**
             * Helper to build the filter string from all clauses.
             * @returns {string} The OData filter string.
             */
            function buildFilterString() {
                let filterString = "";
                const clauses = [];

                Array.from(filterClausesContainer.children).forEach(
                    (clauseDiv, index) => {
                        const logicalOperator = clauseDiv.querySelector(
                            ".logical-operator-select",
                        ).value;
                        const field = clauseDiv.querySelector(
                            "select:nth-of-type(2)",
                        ).value; // Second select is field
                        const operator = clauseDiv.querySelector(
                            "select:nth-of-type(3)",
                        ).value; // Third select is operator
                        const value = clauseDiv
                            .querySelector('input[type="text"]')
                            .value.trim();

                        if (field && value) {
                            let formattedValue = value;
                            const fieldMetadata = TABLE_FIELDS_METADATA[
                                tableSelect.value
                            ]?.find((f) => f.name === field);
                            const fieldType = fieldMetadata
                                ? fieldMetadata.type.toLowerCase()
                                : "string"; // Default to string if type unknown
                            const isComparisonOperator =
                                COMPARISON_OPERATORS.includes(operator);

                            // Handle quoting based on type and operator
                            if (
                                fieldType === "string" ||
                                fieldType === "nstring"
                            ) {
                                formattedValue = `'${value.replace(/'/g, "''")}'`; // Always quote explicit string types
                            } else if (
                                fieldType === "datetime" ||
                                fieldType === "datetimeoffset"
                            ) {
                                if (!isComparisonOperator) {
                                    // If it's a date type but not a comparison operator (e.g., 'contains'), treat as string and quote
                                    formattedValue = `'${value.replace(/'/g, "''")}'`;
                                }
                                // Else (it's a date type AND a comparison operator), leave as is (no quotes)
                                // The URL encoding of the whole filter string will handle characters like '+'
                            } else if (
                                fieldType === "bit" ||
                                fieldType === "boolean"
                            ) {
                                formattedValue =
                                    value.toLowerCase() === "true"
                                        ? "true"
                                        : "false"; // 'true'/'false' not quoted
                            }
                            // For numeric types, formattedValue remains 'value' (no quotes needed)

                            let clause = "";
                            if (
                                ["contains", "startswith", "endswith"].includes(
                                    operator,
                                )
                            ) {
                                clause = `${operator}(${field}, ${formattedValue})`;
                            } else {
                                clause = `${field} ${operator} ${formattedValue}`;
                            }

                            clauses.push({
                                logicalOperator:
                                    index > 0 ? logicalOperator : "",
                                clause: clause,
                            });
                        }
                    },
                );

                if (clauses.length > 0) {
                    filterString = clauses
                        .map((c, i) => {
                            if (i === 0) return c.clause;
                            return `${c.logicalOperator} ${c.clause}`;
                        })
                        .join(" ");
                }
                return filterString;
            }

            /**
             * Helper to build the orderby string.
             * @returns {string} The OData orderby string.
             */
            function buildOrderByString() {
                const orderByField = orderByFieldSelect.value;
                const orderByDirection = orderByDirectionSelect.value;

                if (orderByField) {
                    return `${orderByField} ${orderByDirection}`;
                }
                return "";
            }

            /**
             * Recursively builds the expand string from nested expand levels.
             * @param {HTMLElement} container - The current container of expand levels.
             * @returns {string} The constructed expand string for this level.
             */
            function buildExpandStringRecursive(container) {
                const expands = [];
                Array.from(container.children).forEach((levelDiv) => {
                    const navPropSelect =
                        levelDiv.querySelector(".nav-prop-select");
                    const customInput = levelDiv.querySelector(
                        ".expand-custom-input",
                    );
                    const nestedContainer = levelDiv.querySelector(
                        ".nested-expands-container",
                    );

                    let currentExpandPart = "";
                    if (customInput && customInput.value.trim()) {
                        currentExpandPart = customInput.value.trim();
                    } else if (navPropSelect && navPropSelect.value) {
                        currentExpandPart = navPropSelect.value;
                    }

                    if (currentExpandPart) {
                        const nestedExpands =
                            buildExpandStringRecursive(nestedContainer);
                        if (nestedExpands) {
                            currentExpandPart = `${currentExpandPart}($expand=${nestedExpands})`;
                        }
                        expands.push(currentExpandPart);
                    }
                });
                return expands.join(",");
            }

            /**
             * Generates a unique and self-explanatory default filename.
             * @returns {string} The suggested filename base.
             */
            function generateDefaultFilename() {
                const table = tableSelect.value;
                let filename = table;

                const filterClauses = Array.from(
                    filterClausesContainer.children,
                )
                    .map((clauseDiv) => {
                        const field = clauseDiv.querySelector(
                            "select:nth-of-type(2)",
                        ).value;
                        const value = clauseDiv
                            .querySelector('input[type="text"]')
                            .value.trim();
                        return field && value ? `${field}_${value}` : "";
                    })
                    .filter(Boolean)
                    .join("_");

                const orderByClause = orderByFieldSelect.value
                    ? `${orderByFieldSelect.value}_${orderByDirectionSelect.value}`
                    : "";

                const expandClause =
                    buildExpandStringRecursive(mainExpandContainer); // Get the combined expand string
                let sanitizedExpandClause = "";
                if (expandClause) {
                    // Basic sanitization for filename
                    sanitizedExpandClause = expandClause
                        .replace(/[^a-zA-Z0-9_]/g, "_")
                        .replace(/_+/g, "_");
                }

                if (filterClauses) {
                    filename += `_filtered_by_${filterClauses}`;
                }
                if (orderByClause) {
                    filename += `_ordered_by_${orderByClause}`;
                }
                if (sanitizedExpandClause) {
                    // Use sanitized value for filename
                    filename += `_expanded_with_${sanitizedExpandClause}`;
                }

                // Sanitize filename: replace spaces and special chars with underscores, truncate if too long
                filename = filename
                    .replace(/[^a-zA-Z0-9_]/g, "_")
                    .replace(/_+/g, "_"); // Replace non-alphanumeric with _, collapse multiple _
                if (filename.length > 50) {
                    // Keep filename reasonable length
                    filename = filename.substring(0, 45) + "...";
                }

                return filename.toLowerCase(); // Consistent lowercase filename
            }

            /**
             * Generates the complete OData URL.
             * @returns {string} The generated OData URL.
             */
            function generateUrl() {
                const selectedTable = tableSelect.value;
                let url = `${BASE_URL}${selectedTable}`;
                const queryParams = [];

                // 1. Generate Filter String
                const filterString = buildFilterString();
                if (filterString) {
                    // Encode and then replace specific OData keywords for correct URL structure
                    let encodedFilter = encodeURIComponent(filterString);
                    encodedFilter = encodedFilter
                        .replace(/%20eq%20/g, " eq ")
                        .replace(/%20ne%20/g, " ne ")
                        .replace(/%20gt%20/g, " gt ")
                        .replace(/%20lt%20/g, " lt ")
                        .replace(/%20ge%20/g, " ge ")
                        .replace(/%20le%20/g, " le ")
                        .replace(/%20and%20/g, " and ")
                        .replace(/%20or%20/g, " or ")
                        .replace(/%20contains%20/g, " contains ")
                        .replace(/%20startswith%20/g, " startswith ")
                        .replace(/%20endswith%20/g, " endswith ");
                    queryParams.push(`$filter=${encodedFilter}`);
                }

                // 2. Generate OrderBy String
                const orderByString = buildOrderByString();
                if (orderByString) {
                    // Encode and then replace specific OData keywords for correct URL structure
                    let encodedOrderBy = encodeURIComponent(orderByString);
                    encodedOrderBy = encodedOrderBy
                        .replace(/%20asc/g, " asc")
                        .replace(/%20desc/g, " desc");
                    queryParams.push(`$orderby=${encodedOrderBy}`);
                }

                // 3. Generate Expand String
                const expandValue =
                    buildExpandStringRecursive(mainExpandContainer); // Use the new buildExpandStringRecursive function
                if (expandValue) {
                    // Encode the entire expand string
                    let encodedExpand = encodeURIComponent(expandValue);
                    // Selectively decode structural characters for OData
                    encodedExpand = encodedExpand
                        .replace(/%28/g, "(") // Decode '('
                        .replace(/%29/g, ")") // Decode ')'
                        .replace(/%2F/g, "/"); // Decode '/'
                    queryParams.push(`$expand=${encodedExpand}`);
                }

                // Combine all query parameters
                if (queryParams.length > 0) {
                    url += `?${queryParams.join("&")}`;
                }

                outputUrl.value = url; // Set value for textarea
                filenameInput.value = generateDefaultFilename(); // Update default filename
            }

            /**
             * Displays a message in the message box.
             * @param {string} message - The message to display.
             * @param {string} type - The type of message (e.g., 'success', 'error').
             */
            function showMessage(message, type) {
                messageBox.textContent = message;
                messageBox.className = `message-box ${type}`; // Apply type class
                messageBox.style.display = "block";
                setTimeout(() => {
                    messageBox.style.display = "none";
                }, 3000); // Hide after 3 seconds
            }

            /**
             * Sets the loading state for the fetch button.
             * @param {boolean} isLoading - True to show loading, false to hide.
             */
            function setFetchLoadingState(isLoading) {
                fetchAndSaveBtn.disabled = isLoading;
                if (isLoading) {
                    fetchAndSaveBtn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Fetching...
                `;
                } else {
                    fetchAndSaveBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Fetch & Save Data (on server)
                `;
                }
            }

            /**
             * Sends the generated URL to the Python backend to fetch and save data.
             */
            async function sendUrlToBackendAndSave() {
                const urlToFetch = outputUrl.value; // Get value from textarea
                const filenameBase = filenameInput.value.trim();
                const saveFormat = saveFormatSelect.value;

                if (!urlToFetch) {
                    showMessage("Please generate a URL first.", "error");
                    return;
                }

                setFetchLoadingState(true); // Show loading indicator
                showMessage(
                    "Sending request to server to fetch data...",
                    "info",
                );

                try {
                    const response = await fetch(BACKEND_URL, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            url: urlToFetch,
                            filename: filenameBase,
                            save_format: saveFormat,
                        }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showMessage(`Success: ${result.message}`, "success");
                    } else {
                        showMessage(
                            `Error: ${result.message || "Unknown error from server."}`,
                            "error",
                        );
                    }
                } catch (error) {
                    console.error("Error communicating with backend:", error);
                    showMessage(
                        `Network error: Could not connect to the Python server. Make sure it's running at ${BACKEND_URL}.`,
                        "error",
                    );
                } finally {
                    setFetchLoadingState(false); // Hide loading indicator
                }
            }

            // Event Listeners
            generateUrlBtn.addEventListener("click", generateUrl);

            copyUrlBtn.addEventListener("click", () => {
                const urlToCopy = outputUrl.value; // Get value from textarea
                if (urlToCopy) {
                    // Use document.execCommand('copy') for clipboard operations in iframe environments
                    const tempInput = document.createElement("textarea");
                    tempInput.value = urlToCopy;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    try {
                        document.execCommand("copy");
                        showMessage("URL copied to clipboard!", "success");
                    } catch (err) {
                        console.error("Failed to copy URL: ", err);
                        showMessage(
                            "Failed to copy URL. Please copy manually.",
                            "error",
                        );
                    } finally {
                        document.body.removeChild(tempInput);
                    }
                } else {
                    showMessage("No URL to copy. Generate one first!", "error");
                }
            });

            addFilterClauseBtn.addEventListener("click", addFilterClause);
            addTopLevelExpandBtn.addEventListener("click", () =>
                addNestedExpandLevel(mainExpandContainer, tableSelect.value, 0),
            ); // New button click handler
            fetchAndSaveBtn.addEventListener("click", sendUrlToBackendAndSave);

            // Event listener for table selection change
            tableSelect.addEventListener("change", () => {
                // Clear existing filter clauses
                filterClausesContainer.innerHTML = "";
                addFilterClause(); // Add a new empty filter clause for the newly selected table

                // Clear existing expand clauses and add the initial one
                mainExpandContainer.innerHTML = "";
                addNestedExpandLevel(mainExpandContainer, tableSelect.value, 0); // Start the main expand builder

                // Update order by field select
                populateFieldSelect(orderByFieldSelect, tableSelect.value);
                populateExpandSuggestions(); // Populate expand suggestions when table changes
                generateUrl(); // Regenerate URL
            });

            // Event listeners for order by changes and expand changes
            orderByFieldSelect.addEventListener("change", generateUrl);
            orderByDirectionSelect.addEventListener("change", generateUrl);
            // Note: Expand clause events are added dynamically within addNestedExpandLevel
            // Note: Filter clause events already call generateUrl on value change

            // Initialize the UI on page load
            window.onload = () => {
                populateTableSelect();
                addFilterClause(); // Add the first filter clause on load
                addNestedExpandLevel(mainExpandContainer, tableSelect.value, 0); // Start the main expand builder on load
                populateFieldSelect(orderByFieldSelect, tableSelect.value); // Populate order by fields
                populateExpandSuggestions(); // Populate expand suggestions on load
                generateUrl(); // Generate initial URL and filename on load
            };
        </script>
    </body>
</html>
